---
title: "Logistic Regression Model for Vehicle Risk Assessment"
author: "Ariyan Sajid"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

# Project Overview

This project develops a logistic regression model to classify high-risk driving scenarios based on NGSIM trajectory data. The model uses Time-To-Collision (TTC) as the primary risk indicator, with TTC values between 0 and 4 seconds classified as high-risk situations.

# 1. Setup & Libraries

```{r libraries}
library(dplyr)
library(readr)
library(caret)
library(pROC)
library(ggplot2)
library(zoo)

# Set seed for reproducibility
set.seed(123)
```

# 2. Data Loading

```{r data-loading}
# Check if zip file exists
if (!file.exists("TrajectoryData.zip")) {
  stop("TrajectoryData.zip not found in the project directory!")
}

# Unzip data if needed
if (!dir.exists("TrajectoryData")) {
  cat("Extracting TrajectoryData.zip\n")
  unzip("TrajectoryData.zip", exdir = ".")
  cat("Extraction complete\n")
}

# Load Training Data, remove unneeded columns
cat("Loading training data\n")
train_data <- read_csv(
  "TrajectoryData/0750am-0805am.csv",
  col_types = cols_only(
    Vehicle_ID = col_double(),
    Frame_ID = col_double(),
    v_Vel = col_double(),
    v_Acc = col_double(),
    Space_Hdwy = col_double(),
    Preceeding = col_double(),
    v_Length = col_double(),
    Lane_ID = col_double(),
    v_Class = col_double()
  )
)

# Remove vehicles with no vehicle ahead
train_data <- train_data %>%
  filter(Preceeding != 0)

cat("Training data loaded:", nrow(train_data), "rows\n")

# Load Testing Data, remove unneeded columns
cat("Loading testing data\n")
test_data <- read_csv(
  "TrajectoryData/0820am-0835am.csv",
  col_types = cols_only(
    Vehicle_ID = col_double(),
    Frame_ID = col_double(),
    v_Vel = col_double(),
    v_Acc = col_double(),
    Space_Hdwy = col_double(),
    Preceeding = col_double(),
    v_Length = col_double(),
    Lane_ID = col_double(),
    v_Class = col_double()
  )
)

# Remove vehicles with no vehicle ahead
test_data <- test_data %>%
  filter(Preceeding != 0)

cat("Testing data loaded:", nrow(test_data), "rows\n")
```

# 3. Feature Engineering

## 3.1 Training Data Feature Engineering

```{r train-feature-engineering}
cat("Engineering features for training data\n")

# NGSIM data is at 10 Hz --> 2s = 20 frames
DELTA_T_FRAMES <- 20
TTC_THRESHOLD <- 4.0

# Self-join
train_features <- train_data %>%
  rename(
    Vehicle_ID_Subject = Vehicle_ID,
    v_Vel_Subject = v_Vel,
    v_Acc_Subject = v_Acc,
    v_Length_Subject = v_Length,
    Space_Hdwy_Subject = Space_Hdwy,
    Lane_ID_Subject = Lane_ID,
    v_Class_Subject = v_Class,
    Preceeding_ID = Preceeding
  ) %>%
  inner_join(
    train_data %>%
      select(Vehicle_ID, Frame_ID, v_Vel, v_Length) %>%
      rename(Preceeding_ID = Vehicle_ID, v_Vel_Lead = v_Vel, v_Length_Lead = v_Length),
    by = c("Preceeding_ID", "Frame_ID")
  ) %>%
  mutate(
    Relative_Speed = v_Vel_Subject - v_Vel_Lead,
    Actual_Gap = Space_Hdwy_Subject - (v_Length_Subject / 2) - (v_Length_Lead / 2),
    TTC_current = Actual_Gap / Relative_Speed
  )

# Self-join for future TTC
# At time t, get TTC at time (t + DELTA_T_FRAMES)
train_future <- train_features %>%
  select(Vehicle_ID_Subject, Frame_ID, Preceeding_ID, TTC_current) %>%
  mutate(Frame_ID_past = Frame_ID - DELTA_T_FRAMES) %>%
  rename(TTC_future = TTC_current)

train_processed <- train_features %>%
  left_join(
    train_future %>% select(Vehicle_ID_Subject, Frame_ID_past, TTC_future),
    by = c("Vehicle_ID_Subject" = "Vehicle_ID_Subject", "Frame_ID" = "Frame_ID_past")
  ) %>%
  # Label: will TTC be < threshold in 2 seconds?
  mutate(
    is_high_risk = if_else(
      !is.na(TTC_future) & TTC_future > 0 & TTC_future < TTC_THRESHOLD,
      1,
      0
    )
  ) %>%
  # Features at time t
  select(
    Vehicle_ID = Vehicle_ID_Subject,
    Frame_ID,
    v_Vel = v_Vel_Subject,
    v_Acc = v_Acc_Subject,
    Space_Hdwy = Space_Hdwy_Subject,
    Relative_Speed,
    Lane_ID = Lane_ID_Subject,
    v_Class = v_Class_Subject,
    TTC_current,
    is_high_risk
  ) %>%
  filter(
    !is.na(TTC_current),
    !is.infinite(TTC_current),
    !is.na(is_high_risk),
    !is.na(Space_Hdwy),
    !is.na(Relative_Speed)
  )

cat("Training data after feature engineering:", nrow(train_processed), "rows\n")
cat("High risk cases:", sum(train_processed$is_high_risk), "\n")
cat("Low risk cases:", sum(train_processed$is_high_risk == 0), "\n")
```

## 3.2 Testing Data Feature Engineering

```{r test-feature-engineering}
cat("Engineering features for testing data...\n")

# Self-join to get current features
test_features <- test_data %>%
  rename(
    Vehicle_ID_Subject = Vehicle_ID,
    v_Vel_Subject = v_Vel,
    v_Acc_Subject = v_Acc,
    v_Length_Subject = v_Length,
    Space_Hdwy_Subject = Space_Hdwy,
    Lane_ID_Subject = Lane_ID,
    v_Class_Subject = v_Class,
    Preceeding_ID = Preceeding
  ) %>%
  inner_join(
    test_data %>%
      select(Vehicle_ID, Frame_ID, v_Vel, v_Length) %>%
      rename(Preceeding_ID = Vehicle_ID, v_Vel_Lead = v_Vel, v_Length_Lead = v_Length),
    by = c("Preceeding_ID", "Frame_ID")
  ) %>%
  mutate(
    Relative_Speed = v_Vel_Subject - v_Vel_Lead,
    Actual_Gap = Space_Hdwy_Subject - (v_Length_Subject / 2) - (v_Length_Lead / 2),
    TTC_current = Actual_Gap / Relative_Speed
  )

# Get future TTC for labels
test_future <- test_features %>%
  select(Vehicle_ID_Subject, Frame_ID, Preceeding_ID, TTC_current) %>%
  mutate(Frame_ID_past = Frame_ID - DELTA_T_FRAMES) %>%
  rename(TTC_future = TTC_current)

test_processed <- test_features %>%
  left_join(
    test_future %>% select(Vehicle_ID_Subject, Frame_ID_past, TTC_future),
    by = c("Vehicle_ID_Subject" = "Vehicle_ID_Subject", "Frame_ID" = "Frame_ID_past")
  ) %>%
  mutate(
    is_high_risk = if_else(
      !is.na(TTC_future) & TTC_future > 0 & TTC_future < TTC_THRESHOLD,
      1,
      0
    )
  ) %>%
  select(
    Vehicle_ID = Vehicle_ID_Subject,
    Frame_ID,
    v_Vel = v_Vel_Subject,
    v_Acc = v_Acc_Subject,
    Space_Hdwy = Space_Hdwy_Subject,
    Relative_Speed,
    Lane_ID = Lane_ID_Subject,
    v_Class = v_Class_Subject,
    TTC_current,
    is_high_risk
  ) %>%
  filter(
    !is.na(TTC_current),
    !is.infinite(TTC_current),
    !is.na(is_high_risk),
    !is.na(Space_Hdwy),
    !is.na(Relative_Speed)
  )

cat("Testing data after feature engineering:", nrow(test_processed), "rows\n")
cat("High risk cases:", sum(test_processed$is_high_risk), "\n")
cat("Low risk cases:", sum(test_processed$is_high_risk == 0), "\n")
```

## 3.3 Feature Distribution Summary

```{r feature-summary}
# Training data summary
cat("\n=== TRAINING DATA SUMMARY ===\n")
summary(train_processed %>% select(v_Vel, v_Acc, Space_Hdwy, Relative_Speed, TTC_current))

# Testing data summary
cat("\n=== TESTING DATA SUMMARY ===\n")
summary(test_processed %>% select(v_Vel, v_Acc, Space_Hdwy, Relative_Speed, TTC_current))
```

# 4. Modeling

```{r model-training-full}
cat("\nTraining logistic regression model (full features)...\n")

# Model with all features including TTC_current
model_full <- glm(
  is_high_risk ~ v_Vel + v_Acc + Space_Hdwy + Relative_Speed + Lane_ID + TTC_current,
  data = train_processed,
  family = binomial(link = "logit")
)

cat("\n=== FULL MODEL SUMMARY ===\n")
summary(model_full)
```

# 5. Evaluation

## 5.1 Full Model Evaluation

```{r eval-full}
# Predictions from full model
prob_full <- predict(model_full, newdata = test_processed, type = "response")
pred_full <- if_else(prob_full > 0.5, 1, 0)

# Confusion matrix
cm_full <- confusionMatrix(
  factor(pred_full, levels = c(0, 1)),
  factor(test_processed$is_high_risk, levels = c(0, 1)),
  positive = "1"
)

# ROC/AUC
roc_full <- roc(test_processed$is_high_risk, prob_full, levels = c(0, 1), direction = "<")
auc_full <- auc(roc_full)

cat("\n=== FULL MODEL METRICS ===\n")
cat(sprintf("Accuracy:  %.4f\n", cm_full$overall["Accuracy"]))
cat(sprintf("Precision: %.4f\n", cm_full$byClass["Precision"]))
cat(sprintf("Recall:    %.4f\n", cm_full$byClass["Sensitivity"]))
cat(sprintf("AUC:       %.4f\n", auc_full))
```

## 5.3 Model Comparison

```{r model-comparison}
cat("\n=== LEAKAGE CHECK: MODEL COMPARISON ===\n")
cat("Full model includes TTC_current; Reduced model excludes it.\n")
cat("Large performance gap suggests TTC_current contains label information.\n\n")

comparison <- data.frame(
  Model = c("Full (with TTC)", "Reduced (no TTC)"),
  Accuracy = c(cm_full$overall["Accuracy"], cm_reduced$overall["Accuracy"]),
  Precision = c(cm_full$byClass["Precision"], cm_reduced$byClass["Precision"]),
  Recall = c(cm_full$byClass["Sensitivity"], cm_reduced$byClass["Sensitivity"]),
  AUC = c(auc_full, auc_reduced)
)
print(comparison)

cat("\n")
if (auc_full - auc_reduced > 0.05) {
  cat("⚠️  Significant performance drop without TTC_current.\n")
  cat("TTC_current may still contain predictive leakage.\n")
} else {
  cat("✓ Performance similar between models. Leakage likely eliminated.\n")
}
```

## 5.4 Class Distribution

```{r class-distribution}
cat("\n=== CLASS DISTRIBUTION ===\n")
test_high_risk_pct <- mean(test_processed$is_high_risk) * 100
cat(sprintf("High Risk: %.2f%%\n", test_high_risk_pct))
cat(sprintf("Low Risk:  %.2f%%\n", 100 - test_high_risk_pct))

baseline_acc <- max(test_high_risk_pct, 100 - test_high_risk_pct) / 100
cat(sprintf("\nBaseline (majority class): %.4f\n", baseline_acc))
cat(sprintf("Full model improvement:    %.4f\n", cm_full$overall["Accuracy"] - baseline_acc))
cat(sprintf("Reduced model improvement: %.4f\n", cm_reduced$overall["Accuracy"] - baseline_acc))
```

## 5.5 ROC Curves

```{r roc-curves, fig.width=10, fig.height=6}
# Plot ROC for both models
roc_data_full <- data.frame(
  FPR = 1 - roc_full$specificities,
  TPR = roc_full$sensitivities,
  Model = "Full (with TTC)"
)

roc_data_reduced <- data.frame(
  FPR = 1 - roc_reduced$specificities,
  TPR = roc_reduced$sensitivities,
  Model = "Reduced (no TTC)"
)

roc_combined <- rbind(roc_data_full, roc_data_reduced)

ggplot(roc_combined, aes(x = FPR, y = TPR, color = Model)) +
  geom_line(size = 1.2) +
  geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "gray") +
  labs(
    title = "ROC Curves: Full vs Reduced Model",
    x = "False Positive Rate",
    y = "True Positive Rate"
  ) +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, face = "bold"))
```

# 6. Prediction Horizon Sensitivity

```{r horizon-sensitivity}
cat("\n=== PREDICTION HORIZON SENSITIVITY ===\n")
cat("Testing Δt = 1, 2, 3 seconds\n\n")

# Horizons to test (in frames: 10 Hz data)
horizons <- c(10, 20, 30)  # 1, 2, 3 seconds
horizon_results <- list()

for (delta_t in horizons) {
  # Training labels
  train_future_h <- train_features %>%
    select(Vehicle_ID_Subject, Frame_ID, TTC_current) %>%
    mutate(Frame_ID_past = Frame_ID - delta_t) %>%
    rename(TTC_future = TTC_current)

  train_h <- train_features %>%
    left_join(
      train_future_h %>% select(Vehicle_ID_Subject, Frame_ID_past, TTC_future),
      by = c("Vehicle_ID_Subject", "Frame_ID" = "Frame_ID_past")
    ) %>%
    mutate(
      is_high_risk = if_else(!is.na(TTC_future) & TTC_future > 0 & TTC_future < TTC_THRESHOLD, 1, 0)
    ) %>%
    select(v_Vel = v_Vel_Subject, v_Acc = v_Acc_Subject, Space_Hdwy = Space_Hdwy_Subject,
           Relative_Speed, Lane_ID = Lane_ID_Subject, is_high_risk) %>%
    filter(!is.na(is_high_risk))

  # Testing labels
  test_future_h <- test_features %>%
    select(Vehicle_ID_Subject, Frame_ID, TTC_current) %>%
    mutate(Frame_ID_past = Frame_ID - delta_t) %>%
    rename(TTC_future = TTC_current)

  test_h <- test_features %>%
    left_join(
      test_future_h %>% select(Vehicle_ID_Subject, Frame_ID_past, TTC_future),
      by = c("Vehicle_ID_Subject", "Frame_ID" = "Frame_ID_past")
    ) %>%
    mutate(
      is_high_risk = if_else(!is.na(TTC_future) & TTC_future > 0 & TTC_future < TTC_THRESHOLD, 1, 0)
    ) %>%
    select(v_Vel = v_Vel_Subject, v_Acc = v_Acc_Subject, Space_Hdwy = Space_Hdwy_Subject,
           Relative_Speed, Lane_ID = Lane_ID_Subject, is_high_risk) %>%
    filter(!is.na(is_high_risk))

  # Train model
  model_h <- glm(is_high_risk ~ v_Vel + v_Acc + Space_Hdwy + Relative_Speed + Lane_ID,
                 data = train_h, family = binomial(link = "logit"))

  # Evaluate
  prob_h <- predict(model_h, newdata = test_h, type = "response")
  pred_h <- if_else(prob_h > 0.5, 1, 0)

  cm_h <- confusionMatrix(factor(pred_h, levels = c(0, 1)),
                          factor(test_h$is_high_risk, levels = c(0, 1)), positive = "1")

  roc_h <- roc(test_h$is_high_risk, prob_h, levels = c(0, 1), direction = "<")
  auc_h <- auc(roc_h)

  # Store results
  horizon_results[[as.character(delta_t)]] <- data.frame(
    Delta_t_sec = delta_t / 10,
    Accuracy = cm_h$overall["Accuracy"],
    Precision = cm_h$byClass["Precision"],
    Recall = cm_h$byClass["Sensitivity"],
    AUC = auc_h
  )
}

# Combine and display
horizon_comparison <- do.call(rbind, horizon_results)
rownames(horizon_comparison) <- NULL
print(horizon_comparison)
```

# 7. Temporal Aggregation Features

## 7.1 Add Rolling Features

```{r rolling-features}
cat("\n=== TEMPORAL AGGREGATION FEATURES ===\n")
cat("Computing rolling statistics (1 second = 10 frames window)\n\n")

ROLLING_WINDOW <- 10

# Add rolling features to training data
train_rolling <- train_processed %>%
  arrange(Vehicle_ID, Frame_ID) %>%
  group_by(Vehicle_ID) %>%
  mutate(
    v_Vel_roll = zoo::rollmean(v_Vel, k = ROLLING_WINDOW, fill = NA, align = "right"),
    v_Acc_roll = zoo::rollmean(v_Acc, k = ROLLING_WINDOW, fill = NA, align = "right"),
    Space_Hdwy_roll = zoo::rollmean(Space_Hdwy, k = ROLLING_WINDOW, fill = NA, align = "right")
  ) %>%
  ungroup() %>%
  filter(!is.na(v_Vel_roll), !is.na(v_Acc_roll), !is.na(Space_Hdwy_roll))

# Add rolling features to testing data
test_rolling <- test_processed %>%
  arrange(Vehicle_ID, Frame_ID) %>%
  group_by(Vehicle_ID) %>%
  mutate(
    v_Vel_roll = zoo::rollmean(v_Vel, k = ROLLING_WINDOW, fill = NA, align = "right"),
    v_Acc_roll = zoo::rollmean(v_Acc, k = ROLLING_WINDOW, fill = NA, align = "right"),
    Space_Hdwy_roll = zoo::rollmean(Space_Hdwy, k = ROLLING_WINDOW, fill = NA, align = "right")
  ) %>%
  ungroup() %>%
  filter(!is.na(v_Vel_roll), !is.na(v_Acc_roll), !is.na(Space_Hdwy_roll))

cat("Training data with rolling features:", nrow(train_rolling), "rows\n")
cat("Testing data with rolling features:", nrow(test_rolling), "rows\n")
```

## 7.2 Baseline vs Enhanced Model

```{r rolling-comparison}
# Baseline: instantaneous features only
model_baseline <- glm(
  is_high_risk ~ v_Vel + v_Acc + Space_Hdwy + Relative_Speed + Lane_ID,
  data = train_rolling, family = binomial(link = "logit")
)

# Enhanced: with rolling features
model_enhanced <- glm(
  is_high_risk ~ v_Vel + v_Acc + Space_Hdwy + Relative_Speed + Lane_ID +
    v_Vel_roll + v_Acc_roll + Space_Hdwy_roll,
  data = train_rolling, family = binomial(link = "logit")
)

# Evaluate baseline
prob_baseline <- predict(model_baseline, newdata = test_rolling, type = "response")
pred_baseline <- if_else(prob_baseline > 0.5, 1, 0)
cm_baseline <- confusionMatrix(factor(pred_baseline, levels = c(0, 1)),
                               factor(test_rolling$is_high_risk, levels = c(0, 1)), positive = "1")
roc_baseline <- roc(test_rolling$is_high_risk, prob_baseline, levels = c(0, 1), direction = "<")
auc_baseline <- auc(roc_baseline)

# Evaluate enhanced
prob_enhanced <- predict(model_enhanced, newdata = test_rolling, type = "response")
pred_enhanced <- if_else(prob_enhanced > 0.5, 1, 0)
cm_enhanced <- confusionMatrix(factor(pred_enhanced, levels = c(0, 1)),
                               factor(test_rolling$is_high_risk, levels = c(0, 1)), positive = "1")
roc_enhanced <- roc(test_rolling$is_high_risk, prob_enhanced, levels = c(0, 1), direction = "<")
auc_enhanced <- auc(roc_enhanced)

# Comparison table
rolling_comparison <- data.frame(
  Model = c("Baseline (instantaneous)", "Enhanced (+ rolling features)"),
  Accuracy = c(cm_baseline$overall["Accuracy"], cm_enhanced$overall["Accuracy"]),
  Precision = c(cm_baseline$byClass["Precision"], cm_enhanced$byClass["Precision"]),
  Recall = c(cm_baseline$byClass["Sensitivity"], cm_enhanced$byClass["Sensitivity"]),
  AUC = c(auc_baseline, auc_enhanced)
)

cat("\n=== BASELINE VS ENHANCED MODEL ===\n")
print(rolling_comparison)
```

# 8. Vehicle Class Segmentation

```{r vehicle-class-analysis}
cat("\n=== VEHICLE CLASS SEGMENTATION ===\n")
cat("Analyzing performance by vehicle class\n\n")

# Use best performing model (enhanced with rolling features)
test_rolling_with_pred <- test_rolling %>%
  mutate(
    predicted = pred_enhanced,
    actual = is_high_risk
  )

# Get unique vehicle classes
vehicle_classes <- sort(unique(test_rolling_with_pred$v_Class))

class_results <- list()

for (vc in vehicle_classes) {
  subset_data <- test_rolling_with_pred %>% filter(v_Class == vc)

  if (nrow(subset_data) < 10) next  # Skip if too few samples

  # Confusion matrix components
  tp <- sum(subset_data$predicted == 1 & subset_data$actual == 1)
  fp <- sum(subset_data$predicted == 1 & subset_data$actual == 0)
  tn <- sum(subset_data$predicted == 0 & subset_data$actual == 0)
  fn <- sum(subset_data$predicted == 0 & subset_data$actual == 1)

  # Metrics
  fpr <- if ((fp + tn) > 0) fp / (fp + tn) else NA
  fnr <- if ((fn + tp) > 0) fn / (fn + tp) else NA
  precision <- if ((tp + fp) > 0) tp / (tp + fp) else NA
  recall <- if ((tp + fn) > 0) tp / (tp + fn) else NA

  class_results[[as.character(vc)]] <- data.frame(
    v_Class = vc,
    n_samples = nrow(subset_data),
    TP = tp,
    FP = fp,
    TN = tn,
    FN = fn,
    FPR = fpr,
    FNR = fnr,
    Precision = precision,
    Recall = recall
  )
}

# Combine results
class_comparison <- do.call(rbind, class_results)
rownames(class_comparison) <- NULL

cat("\n=== CONFUSION MATRIX BY VEHICLE CLASS ===\n")
print(class_comparison %>% select(v_Class, n_samples, TP, FP, TN, FN))

cat("\n=== ERROR RATES BY VEHICLE CLASS ===\n")
print(class_comparison %>% select(v_Class, FPR, FNR, Precision, Recall))

cat("\n=== INTERPRETATION ===\n")
high_fpr_classes <- class_comparison %>% filter(FPR > median(FPR, na.rm = TRUE)) %>% pull(v_Class)
high_fnr_classes <- class_comparison %>% filter(FNR > median(FNR, na.rm = TRUE)) %>% pull(v_Class)

if (length(high_fpr_classes) > 0) {
  cat(sprintf("Classes with high FPR (over-predicted as high-risk): %s\n",
              paste(high_fpr_classes, collapse = ", ")))
}
if (length(high_fnr_classes) > 0) {
  cat(sprintf("Classes with high FNR (under-predicted as high-risk): %s\n",
              paste(high_fnr_classes, collapse = ", ")))
}
```

# 9. Conclusion

```{r conclusion}
cat("\n=== SUMMARY ===\n")
cat("Prediction task: Future high-risk events (TTC < 4 sec in future)\n")
cat("Label construction eliminates instantaneous TTC-based leakage.\n\n")

cat("Key Findings:\n")
cat("1. Prediction horizon sensitivity: See Section 6\n")
cat("2. Rolling features impact: See Section 7\n")
cat("3. Vehicle class differences: See Section 8\n\n")

cat(sprintf("Total test cases: %d\n", nrow(test_processed)))
cat(sprintf("\nReduced model (Δt=2sec, no TTC_current):\n"))
cat(sprintf("  Accuracy:  %.4f\n", cm_reduced$overall["Accuracy"]))
cat(sprintf("  Precision: %.4f\n", cm_reduced$byClass["Precision"]))
cat(sprintf("  Recall:    %.4f\n", cm_reduced$byClass["Sensitivity"]))
cat(sprintf("  AUC:       %.4f\n", auc_reduced))
```
